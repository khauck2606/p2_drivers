---
title: "Projecting the public health, economic and educational benefits of CEPIâ€™s 100 day mission with the DAEDALUS model"
date: "`r format(Sys.time(), '%d %B, %Y')`"
geometry: margin=1cm
header-includes:
  - \usepackage{eso-pic,graphicx,transparent}
  - \usepackage{fancyhdr}
  - \usepackage{lastpage}
output:
  bookdown::html_document2: 
    toc: true
    toc_float: true
    keep_md: true
  bookdown::pdf_document2: 
    toc_depth: 5
    toc_float: true
    number_sections: true
    keep_tex: true
  md_document:
    variant: markdown_github
  bookdown::word_document2: default
  bookdown::github_document2:
    toc: true
    appendix: true
    fig_caption: yes
    number_sections: yes
    toc_float: true
    pandoc_args: --webtex
always_allow_html: yes 
bibliography: 
  - "DAEDALUS.bib"
---

\fancypagestyle{plain}{%
  \renewcommand{\headrulewidth}{0pt}%
  \fancyhf{}%
  \fancyfoot[R]{\footnotesize \thepage}
  \setlength\footskip{0pt}
}
\pagestyle{plain}
  
<!-- \AddToShipoutPictureFG{ -->
<!--   \AtPageCenter{% or \AtTextCenter -->
<!--     \makebox[0pt]{\rotatebox[origin=c]{45}{% -->
<!--       \scalebox{7}{\texttransparent{0.3}{PRELIMINARY DRAFT}}% -->
<!--     }} -->
<!--   } -->
<!-- } -->

```{r setup, include=FALSE}
library(ggplot2)  
library(knitr)     
library(tidyr)
library(dplyr)
library(stringi)
library(gplots)
library(RColorBrewer)
library(data.table)
library(splines)
library(bookdown)
library(pander)
library(haven)
library(viridis)
library(hrbrthemes)
library(MASS)

panderOptions('round',2)
panderOptions('table.split.table', Inf)

knitr::opts_chunk$set(comment=NA, prompt=FALSE, cache=FALSE, echo=F, results='asis')

format_to_print <- function(x,z=-1){
  formatC(round(x,z), format="f", digits=as.numeric(z>0), big.mark=",")
}

```

```{r,echo=F,warning=F,message=F}

internet <- read.csv('data/API_IT.NET.USER.ZS_DS2_en_csv_v2_5455054.csv',header = F) ## more recent
internet <- internet[-c(1:3),-c(3:63,65:nrow(internet))]
colnames(internet) <- c('country','Country.Code','internet')

# dataset <- read.csv('data/internetdata.csv',stringsAs=F) ## 2015/2016
# internetdata <- subset(dataset,Indicator=='Households w/ Internet access, %'&Subindicator.Type=='% households')
# internetdata$internet <- internetdata$X2016
# icols <- which(grepl('X',colnames(internetdata)))
# for(i in rev(icols)) internetdata$internet[is.na(internetdata$internet)] <- internetdata[[i]][is.na(internetdata$internet)]
# internetdata <- internetdata[,colnames(internetdata)%in%c('Country.ISO3','Country.Name','internet')]
# colnames(internetdata) <- c('Country.Code','country','internet')

incomelevels <- read.csv('data/Metadata_Country_API_IT.NET.USER.ZS_DS2_en_csv_v2_5455054.csv')
colnames(incomelevels)[1] <- 'Country.Code'

incomeint <- left_join(internet,incomelevels,by='Country.Code')
internetplot <- ggplot(subset(incomeint,!is.na(IncomeGroup)&IncomeGroup!='')) +  geom_histogram(aes(x=internet),colour='navyblue',fill='grey') +
  facet_wrap(~IncomeGroup) +
  theme_bw(base_size = 15) +
  labs(x='Internet coverage, % (I)',y='')


hic <- fitdistr(subset(incomeint,!is.na(internet)&IncomeGroup=='High income')$internet/100,"beta",start=list(shape1=1,shape2=1))
mic <- fitdistr(subset(incomeint,!is.na(internet)&IncomeGroup%in%c('Upper middle income'))$internet/100,"beta",start=list(shape1=1,shape2=1))
llmic <- fitdistr(subset(incomeint,!is.na(internet)&IncomeGroup%in%c('Low income','Lower middle income'))$internet/100,"beta",start=list(shape1=1,shape2=1))


strategies <- c('No Closures','School Closures','Economic Closures','Elimination')
income_levels <- c('LLMIC','UMIC','HIC')
vaccination_levels <- c(365,100)
bpsv_levels <- c(0,1)

```



\newpage

# Aim

The objective of the proposed work is to use scenario modelling to help ascertain the value of current CEPI investments into the development and distribution of a vaccine 100 days after identification of a new SARS virus (SARS-X) with pandemic potential. In addition, we will estimate the value of a broadly protective sarbecovirus vaccine (BPSV) that would be available prior to the development of the SARS-X--specific vaccine. The analysis scope is to run three new SARS-X health, economic and education impacts scenarios (both for SARS-X 100-day mission and BPSV+SARS-X 100-day mission options) allowing for variations in preparedness and epidemiological parameters (to be discussed). We will will estimate the value of investments for different country types in monetary terms across three dimensions of societal welfare, combining economic losses due to business closures and lost education, and lives lost:

- Health: Live-years saved, monetised using the value of a statistical life (VSL);
- GDP: Gain to short-term economic output from reduced economic closures and disruptions to demand and labour supply;
- Education: long-term economic gains of reduced length and severity of closures of educational institutions.


We will simulate hypothetical pandemics caused by a SARS virus with a disease profile informed by past epidemics. We will use the integrated epi-econ model DAEDALUS developed in our group for estimating the benefit of pandemic preparedness (P2) [@Haw2020]. We will construct three representative hypothetical countries (low- and lower-middle income, upper-middle income, and high income) using real-world demographic, societal and economic data from 197 countries. Within those, we will construct two types of epidemic: those that emerge within the country (which we label "origin"), and those imported from outside (which we label "secondary"). The nature and stringency of non-pharmaceutical mitigation interventions (NPIs) implemented by policy makers once the emergency strikes is an important unknown that will determine benefits of vaccinations. We will therefore evaluate outcomes for four alternative mitigation strategies ("unmitigated," "adaptive economic closures," "school closures," and "elimination") for each vaccination scenario. The faster vaccines control infections, the earlier NPIs can be relaxed. The reduced need for stringent NPIs constitutes the benefit of the 100 day-mission. However, the types of benefit that countries enjoy depend on the chosen NPI. For example, for an unmitigated strategy, significant benefits accrue in terms of deaths averted; for adaptive economic closures, significant benefits accrue in terms of economic gains. It is unknown what NPIs countries will choose for future emergencies. We select the cost-minimising strategy for each country type and income level, assuming that the policy makers' aim is to maximize societal welfare.   

We will estimate the value of the programme to each country group as the difference in total societal costs between scenarios with and without accelerated availability of both a SARS-X--specific vaccine and a BPSV. 
<!-- Table \ref{tab:scenarios} gives an overview over 12 estimated scenarios.  -->


![(\#fig:schematic) Schematic view of the timeline of a pandemic. At time 0 a new SARS pathogen emerges. At time $t_R$ the pathogen is identified following a number of hospitalisations. A pandemic is declared. Genomic sequencing begins. Governments may implement non-pharmaceutical interventions. A broadly protective Sarbecovirus vaccine (BPSV) is rolled out in all places to people aged 65 and over.  At time $t_R+7$ the pathogen is sequenced. Vaccine R&D begins. At time $t_R+7+t_V$ a vaccine specific to the new pathogen is rolled out in all places to people aged 15 and over. $t_V$ is 365 in the BAU scenario and 100 in the 100-day vaccine scenario. At time $t_R+7+t_V+t_E$ vaccine rollout completes. All non-pharmaceutical interventions cease. $t_E$ is 160 times the fraction of the population who are aged 15 and over. At time $t_i$ the pathogen is imported into country $i$. $t_i=0$ for a country in which a spillover event occurs.](figures/Slide2.jpg){ width=90% }
 
 
# Modelling framework

We will use an extensive modelling framework for COVID-19 that has been developed by our team over the last 3 years, the integrated economic--epidemiological model DAEDALUS [@Haw2020]. It is described briefly below and in more detail in the cited publications. The model has been developed in an open-access framework with all code available on Github. The model has been continuously updated throughout the pandemic as our understanding of SARS-CoV-2 transmission and the impact of vaccination has evolved, and is being further updated currently to model other hypothetical respiratory pandemics to answer questions on pandemic preparedness.

## The integrated economic-epidemiological model

The epidemiological component of the DAEDALUS model consists of seven disease states (susceptible, exposed, asymptomatic infectious, symptomatic infectious, hospitalised, recovered, and died), in triplicate to represent vaccination states. The population is stratified by age (into four age groups: infants, adolescents, working-age adults, and retirement-age adults). The working-age adults are further stratified by sector of work (into 46 groups: 45 sectors according to the OECD classification, and one non-working group). We will use epidemiological parameters expected of a future SARS pandemic, where we use past respiratory pandemics to inform our expectations. Epidemiologically relevant demographic parameters, such as mixing matrices, will be drawn from published estimates [@Beraud2015; @Walker2020]. As far as possible, parameters, assumptions and modelling approaches will be closely aligned with Imperial's SARS-X model that is being developed by Prof Azra Ghani and team for Stage 2 of the technical work for CEPI. 

The economic model takes as input the pre-pandemic Gross Value Added (GVA) per sector of countries, which uses the OECD classification of 45 economic sectors. Both models further take as input the observed economic configurations over 2020. These are the observed combinations of sector closures, i.e. the extent to which each sector was open in each period (month or quarter). This depends on the chosen mitigation strategy. All economic configuration profiles will be based on sectoral GVA profiles observed in 2020 (OECD), where the monthly GVA of a sector relative to its value one year prior is interpreted as the degree to which it was open.

A sector is open to a maximum amount of 100%, when its full monthly pre-pandemic GVA value is realised. If a sector is open to 50%, it contributes 50% of its maximum GVA for that period. Sector closures describe the extent of reduction of contacts (and disease transmission) among and between workers and consumers. In the epidemic model, contacts associated with a partially closed sector are scaled down. Observed economic configurations, i.e. sector closures, capture also changes in demand and supply due to infection avoidance of individuals and interruptions in supply chains; we do not attempt to disentangle these from mandated closures. 

## Mitigation strategies

We will model four mitigation strategies that decision maker may adopt once the novel pathogen has been identified. These are "unmitigated," "adaptive economic closures," "school closures," and "elimination." The strategy defines government-mandated actions. In addition, we model behaviour changes in response to case numbers that impact on transmission.
- Unmitigated: no aversive actions are taken. 
- Economic closures: sectors close to a pre-specified economic configuration when hospital occupancy approaches its capacity, and open again once infections have reduced sufficiently. 
- School closures: schools remain closed at 10% and other economic sectors open and close reactively, as in Economic closures. 
- Elimination: stringent economic closures are maintained until case numbers can be contained by a testing programme. 
We will designate the strategy that minimises costs across health, GDP and education to be the mitigation choice for each country type and income level and vaccination scenario. 


## Countries

We will consider three stylised "countries" and parameterise models using data from constituent countries according to the World Bank income-classification categories:

- LLMIC, using inputs from LICs and LMICs
- UMIC, using inputs UMICs
- HIC, using inputs from HICs

We will generate a distribution over outcomes through sampling inputs. This distribution represents a catalogue of synthetic countries whose characteristics are randomly taken from candidate countries. We will include uncertainty in as many parameters as possible. We will sample from specified distributions, or sample with replacement from a discrete set of candidate options, where the candidate options are the values belonging to countries in the income group. We will weigh parameter values according to population sizes of all countries, giving those parameter values greater importance that originate from larger countries.
 
## Vaccination scenarios

Vaccination scenarios will be encoded via the parameters for vaccine effects, the time that vaccination begins, the rate of vaccine administration, and uptake among the population. The baseline scenario will mimic vaccination as observed in the COVID-19 pandemic, with all parameters taken from observations in 2020 and 2021. The 100-day vaccine scenario will assume a vaccine-effect profile similar to those of mRNA COVID-19 vaccines, and that vaccination begins 100 days after SARS-X is sequenced, with alternative administration rate and uptake explored in sensitivity analyses. The BPSV scenario will assume that the 100-day vaccine events will occur, and that, prior to that, the BPSV will be available, with effect parameters more similar to those of an influenza vaccine, with vaccination beginning at the time of identification of the SARS-X virus, and with alternative administration rate and uptake explored in sensitivity analyses.

**TO DO: baseline scenario will be the same as the 100-day scenario, except it will be 365 days. This is approximately when the first COVID-19 vaccines were administered. The scenarios will be aligned on assumptions but the baseline scenario will not be aligned with reality: we will be underestimating the benefits to lower-income countries who were later in obtaining vaccines.**
 
**TO DO: create a new scenario with the BPSV and the 365-day vaccine. Compare all three vaccine scenarios to the BAU scenario.** 



## Valuations

The outcomes of the DAEDALUS model are:

 1. Health: Live-years lost globally and by country income groups;
 2. GDP: Short-term economic loss from economic closures and disruptions to demand and labour supply, globally, by country income groups, and by economic sectors;
 3. Education: long-term economic loss from closures of educational institutions, globally and by country income groups.
 
Numbers of deaths are translated into years of life lost (YLL). This takes into account the life expectancy of each person who dies. YLLs are valued using the value of a statistical life, which we estimate as being 160 times GDP per capita [@Robinson2019].

GDP loss is estimated as the total GDP - the sum of GVA across all sectors, scaled by how open they are across the year - divided by the value of GDP when all sectors are completely open all the time.

Education loss takes into account the extent to which schools are closed, as well as the effectiveness of remote learning. Education loss is valued by taking into consideration life-long earning losses, following [@Psacharopoulos2021a]. 

Taken together, these form the societal cost (SC) of the epidemic in the country, expressed as a percentage of GDP (for the year prior to the pandemic). For each scenario and each country type and income level, we will assume that the social planner chooses the mitigation strategy that minimises the expected SC -- call it the minimum expected SC, or MESC. The value of the 100-day vaccine in each country type and income level will be the MESC of the 100-day vaccine scenario minus the MESC of the baseline scenario. Similarly, the value of the BPSV in each country type and income level will be the MESC of the BPSV scenario minus the MESC of the 100-day vaccine scenario.



## Value of information

We use value-of-information methods to quantify relationships between inputs and outputs. Specifically, we estimate the expected value of partial perfect information (EVPPI), which is the expected gain (in terms of reduction of uncertainty in the outcome) of knowing a parameter (or set of parameters) perfectly [@Jackson2021]. Equivalently, and in terms of identifying indicators of vulnerability, it tells us which parameters best predict the outcome.

Value of information is a decision-theoretic quantity. We estimate it using the R package **voi**. Intuitively, EVPPI functions in a similar way to correlation. In the case of a linear relationship between one input and one output, the computation of EVPPI is essentially the same as that of a correlation. EVPPI extends a simple correlation analysis in two ways relevant to the results presented: 1) nonlinear relationships are also captured, and 2) we can assess the EVPPI of a set of parameters. EVPPI allows us to identify influential parameters. Once identified, relationships between the influential parameter (sets) and outcomes need to be examined independently in order to understand the nature of the relationship.

<!-- Finally, we can use mutual information (MI, via the R package **infotheo**) to assess mutual information between inputs and outputs. What MI offers beyond EVPPI is that it takes into account also how *likely* it is that the input parameter occupies a space where it is influential. -->

<!-- ### Value of information, mutual information, or correlation? -->

<!-- ![(\#fig:voimicorr) Value of information (VOI), mutual information (MI), and correlation (corr) for a standard normal input with outputs of varying covariance with the input.](figures/voimicorr.png){ width=80% } -->

<!-- ![(\#fig:voimicorr100) Value of information (VOI), mutual information (MI), and correlation (corr) for a standard normal input with outputs of varying covariance with the input (as in  Figure \@ref(fig:voimicorr)), with a single outlier with input and output values both equal to 100.](figures/voimicorr100.png){ width=80% } -->

<!-- ![(\#fig:voimicorr0) Value of information (VOI), mutual information (MI), and correlation (corr) for a standard normal input with outputs of varying covariance with the input (as in  Figure \@ref(fig:voimicorr)), with a single outlier with input equal to 100 and output equal to 0.](figures/voimicorr0.png){ width=80% } -->


\newpage

## Scenario levels

Table: Previously:

| **Variable** | **Levels** | **Description** |
| ---- | ---- | ---- |
| **Income level** | HIC  | High-income countries |
|  | UMIC | Upper-middle--income countries |
|  | LLMIC | Low- and lower-middle--income countries |
| **Mitigation strategy** | No closures | Unmitigated pandemic |
|  | School closures | Schools close reactively |
|  | Economic closures | Sectors close reactively |
|  | Elimination | Contain by testing |
| **Country type** | Origin | Where the outbreak begins |
|  | Secondary |To where cases are exported|
| **Vaccination** | BAU | Business as usual |
|  | 100 day | SARS-X vaccine available after 100 days |
|  | BPSV | Broadly protective sarbecovirus vaccine |



Table: Proposed:

| **Variable** | **Levels** | **Description** |
|:-----|:---|:----------|
| **Income level** | HIC  | High-income countries |
|  | UMIC | Upper-middle--income countries |
|  | LLMIC | Low- and lower-middle--income countries |
| **Mitigation strategy** | No closures | Unmitigated pandemic |
|  | School closures | Schools close reactively |
|  | Economic closures | Sectors close reactively |
|  | Elimination | Contain by testing |
| **BPSV** | No | There is no BPSV stockpile |
|  | Yes | Stockpiled BPSV rolled out to 65+ |
| **SARS-X--specific vaccine** | 365 | SARS-X vaccine available 365 days after sequencing |
|  | 100 | SARS-X vaccine available 100 days after sequencing |


## Fixed parameters 

| Parameter | Value | 
| ---- | ---- | 
| Maximum R$_0$ | 4 | 
| Vaccines given per day | 0.5% of population | 
| Final vaccine coverage | 80% of people aged 15+ | 

# Results 

We first present results on the outcomes or costs of pandemics for the analysed scenarios, in total and separately by the three types of outcomes. We then present the estimated values of the vaccine scenarios that arise by computing the reduction in costs associated with vaccination.

## Distributions over outcomes

In this section we present the costs of pandemics, by country category, mitigation strategy, vaccination scenario, and for the three costs separately and summed up. For illustration, results for the BAU Origin countries are shown in Figure \@ref(fig:BAUviolinspill); the figures for the other scenarios are in the Appendix (Figures \@ref(fig:BAUviolinsecond) to  \@ref(fig:violin100second)). Because we are varying key characteristics across countries within a category (LLMIC, MIC, or HIC), there is a distribution over costs, which we present with violin plots (e.g. Figure \@ref(fig:BAUviolinspill)). They show the outcomes of 2,048 modelling runs of the same scenario where each run has a different set of randomly drawn parameters. The top row shows projections for total costs across three outcomes, while the 2nd, 3rd and 4th rows show the different types of costs (YLLS, education and GDP losses). Each shape represents a probability distribution: the most likely value to take is where the figure is widest. The tip of the tail indicates the highest value projected by any modelling run, after which point the density is 0. The base of the violin is given by the lowest value projected. Plots for all virus profiles are shown in Figures \@ref(fig:BAUviolinspill) to \@ref(fig:violin100second), and mean values and 95\% prediction intervals are given in Table \@ref(tab:tabres).

There is high variation in projected costs across modelling runs, for all country types. For some favourable combinations of the randomly drawn parameters (bottom of the violin), costs are just above zero. On the other hand, for a few unfavourable parameter combinations (top of the violin), costs approach 500\% of annual pre-pandemic GDP in Figure \@ref(fig:BAUviolinspill). This area represents extreme adverse outcomes. Our aim in Section \@ref(value-of-information) is to identify which parameters lead to these high-cost outcomes.

<!-- Distributions over costs associated with the first two years of an outbreak of a new SARS-X virus are shown for three income levels and four mitigation strategies. Each shape represents the probability density made up of the sampled values for outcomes: the most likely value to take is where the figure is widest. The tip of the tail indicates the highest value sampled, after which point the density is 0. -->

<!-- These distributions show that vulnerability to a pandemic depends on a country's income level together with its mitigation strategy. For example, the elimination strategy appears to have the lowest distribution for overall cost for HICs among all strategies, whereas it appears no lower for UMICs and perhaps higher for LLMICs. This will be because of the factors that vary systematically across countries of different income levels. Likewise, the heavier tails in the distributions for YLLs for HICs is likely due to the age distributions in HICs being heavier in older ages. These cross-country differences are one of the focuses of the development of the model. -->

```{r resultsBAU,echo=F,warning=F,message=F}


result_cols <- c('Cost','dYLLs','School','GDP_loss')

allresults <- data.frame()

for (i in 1:length(income_levels)){
    for (k in 1:length(strategies)){
        inp3 <- strategies[k];
        income_level <- income_levels[i];
        results <- read.csv(paste0('code/results/VOI_',inp3,'_',income_level,'_365_0.csv'),header=T);
        results$strategy <- inp3
        results$igroup <- income_level
        results$Deaths <- NULL
        allresults <- rbind(allresults,results)
    }
}
nvar <- ncol(results) - 2
for(i in 1:nvar){
  allresults[,i] = as.numeric(allresults[,i]);
}
for(i in (nvar-3):nvar){
  allresults[,i] = allresults[,i]/allresults$GDP*100;
  # allresults[,i] = log(allresults[,i]);
}
vioplot <- melt(allresults[,(nvar-3):ncol(allresults)],id.vars=c('strategy','igroup'))
vioplot$igroup <- factor(vioplot$igroup,levels=c('LLMIC','UMIC','HIC'))
vioplot$strategy <- factor(vioplot$strategy,levels=c('No Closures','School Closures','Economic Closures','Elimination'))
vioplot$variable <- factor(vioplot$variable,
                           levels=c('Cost','dYLLs','School','GDP_loss'),
                           labels=c('Cost','dYLLs','Education','GDP'))


```



```{r tabres,echo=F,warning=F,message=F,results='asis'}

meltmeantab <- c()
allallresults <- tabresall <- data.frame()
p <- list()
for(vl in 1:length(vaccination_levels)){
  vaccination_level <- vaccination_levels[vl]
  p[[vl]] <- list()
  for(bl in 1:length(bpsv_levels)){
    bpsv <- bpsv_levels[bl]

    allresults <- data.frame()
    
    for (i in 1:length(income_levels)){
        for (k in 1:length(strategies)){
            inp3 <- strategies[k];
            income_level <- income_levels[i];
            results <- read.csv(paste0('code/results/VOI_',inp3,'_',income_level,'_',vaccination_level,'_',bpsv,'.csv'),header=T);
            results$Deaths <- NULL
            results$strategy <- inp3
            results$igroup <- income_level
            results$samplei <- 1:nrow(results)
            allresults <- rbind(allresults,results)
        }
    }
    nvar <- which(colnames(results)=='GDP_loss')
    for(i in 1:nvar){
      allresults[,i] = as.numeric(allresults[,i]);
    }
    for(i in (nvar-3):nvar){
      allresults[,i] = allresults[,i]/allresults$GDP*100;
      # allresults[,i] = log(allresults[,i]);
    }
    
    vioplot <- melt(allresults[,(nvar-3):(ncol(allresults)-1)],id.vars=c('strategy','igroup'))
    vioplot$igroup <- factor(vioplot$igroup,levels=c('LLMIC','UMIC','HIC'))
    vioplot$strategy <- factor(vioplot$strategy,levels=c('No Closures','School Closures','Economic Closures','Elimination'))
    vioplot$variable <- factor(vioplot$variable,
                               levels=c('Cost','dYLLs','School','GDP_loss'),
                               labels=c('Cost','dYLLs','Education','GDP'))
    
    p[[vl]][[bl]] <- ggplot(vioplot,aes(fill=igroup, y=value, x=igroup)) + 
      geom_violin(position="dodge", alpha=0.5, outlier.colour="transparent") +
      facet_grid(variable~strategy, scales="free") + 
        scale_fill_viridis(discrete=T, name="") +
        theme_bw(base_size = 12)  +
        xlab("") +
        ylab("Percent of GDP") +
      scale_x_discrete(labels=c('','',''))+ 
      theme(axis.ticks.x=element_blank(),
            panel.spacing = unit(0.5, "lines"),
            legend.position = 'bottom',
            legend.margin=margin(t=-30))


    
    allresults$vaccination_level <- vaccination_level
    allresults$BPSV <- c('No','Yes')[bpsv+1]
    
    allallresults <- rbind(allallresults,allresults)
    
    setDT(allresults)
    allresults[,mincost:=as.numeric(Cost==min(Cost)),by=.(samplei,igroup)]
    
    meantab <- allresults[,.(deaths=mean(dYLLs),
                            education=mean(School),
                            gdp=mean(GDP_loss),
                            nmin=sum(mincost)),by=.(strategy,igroup)]
    meltmean <- reshape2::melt(meantab,id.vars=c('strategy','igroup','nmin'))
    meltmean$scen <- paste0(vaccination_level,', ',c('No BPSV','BPSV')[bpsv+1])
    meltmeantab <- rbind(meltmeantab,meltmean)
    
    tabres <- setDT(allresults)[,list(costs=paste0(round(mean(Cost),1),' (',paste0(round(quantile(Cost,c(0.025,0.975)),1),collapse=', '),')'),
                            deaths=paste0(round(mean(dYLLs),1),' (',paste0(round(quantile(dYLLs,c(0.025,0.975)),1),collapse=', '),')'),
                            education=paste0(round(mean(School),1),' (',paste0(round(quantile(School,c(0.025,0.975)),1),collapse=', '),')'),
                            gdp=paste0(round(mean(GDP_loss),1),' (',paste0(round(quantile(GDP_loss,c(0.025,0.975)),1),collapse=', '),')')
                            ),by=.(strategy,igroup)]
    colnames(tabres) <- c('Strategy','Income group','Total costs','YLLs','Education','GDP')
    tabres$`SARS-X vaccine` <- vaccination_level
    tabres$BPSV <- c('No','Yes')[bpsv+1]
    tabresall <- rbind(tabresall,tabres)

    # write.csv(tabres,paste0('results_',vaccination_level,'_',bpsv,'.csv'),row.names = F)
    # lg <- paste0('Results for the ',vaccination_level,' scenario in a ',bpsv,' country. Mean values and 95% prediction intervals. \\label{tab:tabres100}')
    # if (!knitr::is_html_output(excludes = "markdown")) { 
    #   cat(pander(tabres,caption=lg))
    # }else{
    #   x <- knitr::kable(tabres,escape=F, "html",caption=lg)
    #   (kableExtra::kable_styling(x,full_width = F,latex_options = "HOLD_position"))
    # }
  }
}
tabresall <- cbind(tabresall[,c(7:8)],tabresall[,-c(7:8)])
lg <- paste0('Results for all vaccination levels, scenarios and country types. Mean values and 95% prediction intervals. \\label{tab:tabres}')
if (!knitr::is_html_output(excludes = "markdown")) { 
  cat(pander(tabresall,caption=lg))
}else{
  x <- knitr::kable(tabresall,escape=F, "html",caption=lg)
  (kableExtra::kable_styling(x,full_width = F,latex_options = "HOLD_position"))
}

```


```{r violinBAU,fig.cap='Model results for the 365-day SARS-X vaccine without the BPSV.',echo=F,warning=F,message=F,fig.height=5,fig.width=6}
p[[1]][[1]]

# ggsave(p[[1]][[1]] + theme_bw(base_size=15),filename='BAUviolinspill.png',width=9,height=6.5)
# 
# p[[1]][[1]]

```

```{r violinSARSX,fig.cap='Model results for the 100-day SARS-X vaccine without the BPSV.',echo=F,warning=F,message=F,fig.height=5,fig.width=6}
p[[2]][[1]]
```

```{r violinBPSV,fig.cap='Model results for the 365-day SARS-X vaccine with the BPSV.',echo=F,warning=F,message=F,fig.height=5,fig.width=6}
p[[1]][[2]]
```

```{r violinBPSVSARSX,fig.cap='Model results for the 100-day SARS-X vaccine with the BPSV.',echo=F,warning=F,message=F,fig.height=5,fig.width=6}
p[[2]][[2]]
```

```{r expectedvaluesbar,fig.cap='Expected values of model results.',echo=F,warning=F,message=F,fig.height=6,fig.width=6}

meltmeantab$scen <- factor((meltmeantab$scen), 
                                    levels=c('365, No BPSV','365, BPSV',
                                             '100, No BPSV','100, BPSV'))
setDT(meltmeantab)
# meltmeantab[,cost:=sum(value),by=.(scen,igroup,strategy)]
# meltmeantab[,mincost:=cost==min(cost),by=.(scen,igroup)]
meltmeantab[,mincost:=nmin==max(nmin),by=.(scen,igroup)]
ggplot(meltmeantab) + 
      geom_bar(aes(x=factor(strategy,levels=c('No Closures','School Closures','Economic Closures','Elimination')),
                   y=value,fill=factor(variable,levels=c('education','deaths','gdp'),labels=c('Education','YLLs','GDP')),
                   alpha=I(as.numeric(mincost)*.5+.5)),stat='identity') + 
  facet_grid(factor(igroup,levels=c('LLMIC','UMIC','HIC'))~scen) + 
      theme_bw(base_size=9) +
        scale_fill_viridis(discrete=T, name="",option='inferno') +
      labs(x='',y='Cost, % of GDP',fill='Cost type') +
        theme(axis.text.x = element_text(angle = 45,  hjust=1,vjust=1),
              legend.position = 'top') 
    # ggsave(p,filename='figures/expectedcosts.pdf',height=10)
# subset(meltmeantab,igroup=='HIC'&scen=='100, BPSV')

# ggplot(subset(meltmeantab,grepl('Secondary',igroupcountry))) + 
#       geom_bar(aes(x=factor(strategy,levels=c('No Closures','School Closures','Economic Closures','Elimination')),
#                    y=value,fill=factor(variable,levels=c('education','deaths','gdp'),labels=c('Education','YLLs','GDP')),
#                    alpha=I(as.numeric(mincost)*.5+.5)),stat='identity') + 
#   facet_grid(factor(igroupcountry,labels=c('LLMIC','UMIC','HIC'))~factor(scen,levels=c('BAU','100 days','BPSV'))) + 
#       theme_bw(base_size=15) +
#         scale_fill_viridis(discrete=T, name="",option='inferno') +
#       labs(x='',y='Cost, % of GDP',fill='Cost type') +
#         theme(axis.text.x = element_text(angle = 45,  hjust=1,vjust=1),
#               legend.position = 'right') -> p
# 
# ggsave(p,filename = 'expectedvaluesbar.png',height=6,width=8)


```


\newpage

## Value of vaccination scenarios

Selecting the mitigation strategy that minimises the expected cost for each country type and income level and vaccination scenario, we estimate the value of the vaccines as the difference in costs. These are shown graphically in Figure \@ref(fig:diffviolin) and tabulated in Table \@ref(tab:tabresdiff). The expected value of the 100-day vaccine ranges from  in  countries to  in  countries. The expected value of the BPSV ranges from  in  countries to  in  countries. 

In some cases, the same mitigation strategy is chosen across scenarios, e.g. Economic Closures are chosen by the HIC for all scenarioss (see Figure \@ref(fig:expectedvaluesbar)). Where the choice is the same in the two vaccination scenarios compared, there are expected benefits across all costs. In other cases, the chosen mitigation strategy changes, e.g. an Origin UmIC chooses Economic Closures with the 100-day vaccine and Unmitigated with BAU. Here, there is a greater gain in expected deaths averted offset by expected losses in education and GDP.

Finally, note that there are samples with a negative value. These come from unlikely large exit waves that arise when all NPIs are suspended following completion of the vaccine rollout.  

```{r resultsdiff,echo=F,warning=F,message=F}

difflist <- c()
for(vl in 1:length(vaccination_levels)){
  for(bl in 1:length(bpsv_levels)){
    if(vl>1|bl>1){
      vaccination_level <- vaccination_levels[vl]
      bpsv <- bpsv_levels[bl]
      difftab <- as.data.frame(readRDS(paste0('code/results/difftab_',bpsv,'_',vaccination_level,'.Rds')))
      nvar <- which(colnames(difftab)=='GDP_loss')
      for(i in (nvar-3):nvar){
        difftab[,i] = difftab[,i]/difftab$GDP*100;
      }
      difftab$BPSV <- c('No','Yes')[bpsv+1]
      difftab$Vaccine <- vaccination_level
      difftab$scen <- paste0(c('No BPSV','BPSV')[bpsv+1],', ',vaccination_level, ' days')
      difflist <- rbind(difflist,difftab)
    }
  }
}

```


```{r diffviolin,fig.cap='Model results for costs saved by 100-day and BPS vaccines.',echo=F,warning=F,message=F,fig.height=5,fig.width=6}

vioplot <- melt(difflist[,colnames(difflist)%in%c('Cost','dYLLs','School','GDP_loss','igroup','scen')],id.vars=c('igroup','scen'))
vioplot$igroup <- factor(vioplot$igroup,levels=c('LLMIC','UMIC','HIC'))
vioplot$variable <- factor(vioplot$variable,
                           levels=c('Cost','dYLLs','School','GDP_loss'),
                           labels=c('Total','YLLs','Education','GDP'))

ggplot(vioplot,aes(fill=igroup, y=value, x=igroup)) + 
    geom_violin(position="dodge", alpha=0.5, outlier.colour="transparent") +
  facet_grid(scen~variable, scales="free") + 
    scale_fill_viridis(discrete=T, name="") +
    theme_bw(base_size = 10)  +
    xlab("") +
    ylab("Percent of GDP") +
  scale_x_discrete(labels=c('','',''))+ 
  theme(axis.ticks.x=element_blank(),
        panel.spacing = unit(0.5, "lines"),
        legend.position = 'bottom',
        legend.margin=margin(t=-20))-> p
  # ggsave(p,filename = 'figures/resultsdiff.pdf',width=12,height=10)
  p


```


```{r tabresdiff,tab.cap='Value of vaccines: expected difference between BAU and 100 days. Mean values and 95% prediction intervals.',echo=F,warning=F,message=F}


meantab <- setDT(difflist)[,.(deaths=mean(dYLLs),
                        education=mean(School),
                        gdp=mean(GDP_loss)),by=.(igroup,BPSV,Vaccine)]

tabres <- setDT(difflist)[,list(costs=paste0(round(mean(Cost),1),' (',paste0(round(quantile(Cost,c(0.025,0.975)),1),collapse=', '),')'),
                        deaths=paste0(round(mean(dYLLs),1),' (',paste0(round(quantile(dYLLs,c(0.025,0.975)),1),collapse=', '),')'),
                        education=paste0(round(mean(School),1),' (',paste0(round(quantile(School,c(0.025,0.975)),1),collapse=', '),')'),
                        gdp=paste0(round(mean(GDP_loss),1),' (',paste0(round(quantile(GDP_loss,c(0.025,0.975)),1),collapse=', '),')')
                        ),by=.(BPSV,Vaccine,igroup)]

tabres[,igroup:=factor(igroup,levels=c('LLMIC','UMIC','HIC'))]
tabres[,Vaccine:=factor(Vaccine,levels=c(365,100))]
setorder(tabres,BPSV,Vaccine,igroup)

colnames(tabres) <- c('BPSV','Vaccine','Income group','Total value','YLLs','Education','GDP')


write.csv(tabres,'resultsdiff.csv',row.names = F)
lg <- 'Value of vaccines as a percent of GDP: expected difference between BAU and 100 days, and between 100 days and BPSV. Mean values and 95% prediction intervals. \\label{tab:tabresdiff}'
if (!knitr::is_html_output(excludes = "markdown")) { 
  pander(tabres,caption=lg)
}else{
    x <- knitr::kable(tabres,escape=F, "html",caption=lg)
  kableExtra::kable_styling(x,full_width = F,latex_options = "HOLD_position")
}

# tabres <- subset(tabres,Country=='Secondary')
# tabres$Country <- NULL
# if (!knitr::is_html_output(excludes = "markdown")) { 
#   pander(tabres,caption=lg)
# }else{
#     x <- knitr::kable(tabres,escape=F, "html",caption=lg)
#   kableExtra::kable_styling(x,full_width = F,latex_options = "HOLD_position")
# }

```



## Other visualisations

```{r choicestab,fig.cap='Frequency of mitigation strategy choices.',echo=F,warning=F,message=F,fig.height=4,fig.width=6}

choicestab <- readRDS(paste0('code/results/choicestab.Rds'))
choicestab[,scen:=paste0(c('No BPSV','BPSV')[bpsv+1],', ',vaccination_level,' days')]
ggplot(choicestab) +  
  geom_bar(aes(x=factor(scen,levels=c('No BPSV, 365 days','BPSV, 365 days','No BPSV, 100 days','BPSV, 100 days')),
               y=N/20.48,
               fill=factor(strategy,levels=c('No Closures','School Closures','Economic Closures','Elimination'))),stat='identity') + 
  facet_wrap(~factor(igroup,levels=c('LLMIC','UMIC','HIC'))) + 
  theme_bw(base_size=15) +
  scale_fill_viridis(discrete=T, name="",option='inferno',direction=-1) +
  labs(x='',y='Chosen strategy, % of samples',fill='') +
  theme(axis.text.x = element_text(angle = 45,  hjust=1,vjust=1),
        legend.position = 'right') 

```


```{r importtime,fig.cap='Hospital occupancy at time of response.',echo=F,warning=F,message=F,fig.height=5,fig.width=6}

ggplot(subset(allallresults,strategy=='No Closures'&vaccination_level==365&BPSV=='No'),aes(x=Hospital_occupancy_at_response,y=..density..)) +
  # geom_histogram(colour='white',fill='white') +
  geom_density(aes(colour=factor(igroup,levels=c('LLMIC','UMIC','HIC'))),linewidth=2, alpha=0.5) +
  theme_bw(base_size = 15) +
  labs(x='Hospital occupancy at response time',y='',colour='') +
          scale_colour_viridis(discrete=T, name="") +
  theme(legend.position = 'top')
```



```{r iseqec,fig.cap='Closures for HICs under the Economic Closures strategy.',echo=F,warning=F,message=F,fig.height=5,fig.width=7}
## iseq ########################

iseq <- setDT(read.csv('code/results/iseq_Economic Closures.csv'))
colnames(iseq) <- c('Time','Level','Importation','Country type','Sample')
iseq$Level[iseq$Level==5] <- 1
iseq$Level[iseq$Level==4] <- 2
iseq[,firsttime:=min(Time),by=.(`Country type`,Sample)]
iseq[,earlyclose:=firsttime<Importation-0.101]

ggplot(iseq) +
  geom_line(aes(x=Time,y=Sample,colour=factor(Level,levels=c(1,3,2),labels=c('Open','Closed','Very closed')),group=Sample),linewidth=3) +
  scale_colour_manual(values=c(Open='darkolivegreen3',`Very closed`='firebrick2',Closed='darkgoldenrod1')) +
  facet_wrap(~factor(`Country type`,labels=c('Origin','Secondary'))) +
  geom_point(aes(x=Importation,y=Sample,shape=earlyclose),size=3,show.legend=F) +
  scale_shape_manual(values=c(`TRUE`=16,`FALSE`=1)) +
  theme_bw(base_size = 15) + labs(colour='') + theme(legend.position = 'top')
```

```{r iseqelim,fig.cap='Closures for HICs under the Elimination strategy. *Future development: find the most open configuration for "Closed" that will allow Rt to remain below 1.*',echo=F,warning=F,message=F,fig.height=5,fig.width=7}
## iseq ########################

iseq <- setDT(read.csv('code/results/iseq_Elimination.csv'))
colnames(iseq) <- c('Time','Level','Importation','Country type','Sample')
iseq$Level[iseq$Level==5] <- 1
iseq$Level[iseq$Level==4] <- 2
iseq[,firsttime:=min(Time),by=.(`Country type`,Sample)]
iseq[,earlyclose:=firsttime<Importation-0.101]

ggplot(iseq) +
  geom_line(aes(x=Time,y=Sample,colour=factor(Level,levels=c(1,3,2),labels=c('Open','Closed','Very closed')),group=Sample),linewidth=3) +
  scale_colour_manual(values=c(Open='darkolivegreen3',`Very closed`='firebrick2',Closed='darkgoldenrod1')) +
  facet_wrap(~factor(`Country type`,labels=c('Origin','Secondary'))) +
  geom_point(aes(x=Importation,y=Sample,shape=earlyclose),size=3,show.legend=F) +
  scale_shape_manual(values=c(`TRUE`=16,`FALSE`=1)) +
  theme_bw(base_size = 15) + labs(colour='') + theme(legend.position = 'top')
```


```{r responsetime,fig.cap='Secondary countries: importation time vs. response time. Where importation time is before response time, the epidemic unfolds as in the Origin country, but with an earlier response time. *Future development: there is not a qualitative difference between Origin and Secondary countries. We could therefore remove this label and vary the importation time from 0 to 20, to include the Origin feature. This would also allow for the possibility that a Secondary country with early importation detects, reports and responds earlier than the Origin country.*',echo=F,warning=F,message=F,fig.height=5,fig.width=6}

ggplot(subset(allallresults,strategy=='No Closures'&vaccination_level==365&BPSV=='No'),aes(x=Importation_time,y=Response_time)) +
  # geom_histogram(colour='white',fill='white') +
  geom_point(aes(shape=Importation_time>Response_time),size=3,show.legend=F,alpha=.5,colour='navyblue') +
  # facet_wrap(~factor(bpsv,levels=bpsv_levels),scales='free') +
  theme_bw(base_size = 15) +
  labs(x='Importation time',y='Response time',shape='') +
  scale_shape_manual(values=c(`TRUE`=16,`FALSE`=1)) +
          # scale_colour_viridis(discrete=T, name="") +
  # scale_x_continuous(limits=c(5,30)) +
  scale_y_continuous(limits=c(NA,50)) +
  theme(legend.position = 'top')

```

```{r vsy,fig.cap='The relationship between strategy choice and value of a school year.',echo=F,warning=F,message=F,fig.height=5,fig.width=6}

setDT(allallresults)
allallresults[,mincost:=min(Cost),by=.(igroup,vaccination_level,BPSV,samplei)]
allallresults[,keeprow:=Cost==mincost]
allallresults[,vax:=paste0(c('No BPSV, ','BPSV, ')[as.numeric(BPSV=='Yes')+1],vaccination_level,' days')]
allallresults$strategy <- factor(allallresults$strategy,levels=c('No Closures','School Closures','Economic Closures','Elimination'))

# ggplot(subset(allallresults,keeprow==T)) + 
#   geom_density(aes(x=VSY/GDP,colour=strategy,group=strategy),position='identity',alpha=.5,linewidth=1.25) +
#   facet_grid(factor(igroup,levels=c('LLMIC','UMIC','HIC'))~vax) + 
#   theme_bw(base_size = 13) +
#   theme(axis.text.x = element_text(angle = 45,  hjust=1,vjust=1),
#         legend.position = 'top') + labs(colour='',x='Value of a school year',y='Density')

keptresults <- subset(allallresults,keeprow==T)
keptresults[,qVSY:=rank(VSY/GDP)/.N,by=.(igroup,vax)]

ggplot(keptresults) + 
  geom_histogram(aes(x=qVSY,y=stat(count / sum(count)),fill=strategy,group=strategy),position='fill',bins = 10) +
  facet_grid(factor(igroup,levels=c('LLMIC','UMIC','HIC'))~vax) + 
  theme_bw(base_size = 13) +
  scale_x_continuous(expand=c(0,0)) +
  scale_y_continuous(expand=c(0,0)) +
  scale_fill_viridis(discrete=T, name="",option='inferno',direction=-1) +
  theme(axis.text.x = element_text(angle = 45,  hjust=1,vjust=1),
        legend.position = 'top') + labs(fill='',x='Value of a school year (quantile)',y='Proportion')

```

```{r vsyeffectiveness,fig.cap='The relationship between strategy choice and the effectiveness of remote teaching.',echo=F,warning=F,message=F,fig.height=5,fig.width=6}

# ggplot(subset(allallresults,keeprow==T)) + 
#   geom_density(aes(x=Remote_teaching_effectiveness,colour=strategy,group=strategy),position='identity',alpha=.5,linewidth=1.25) +
#   facet_grid(factor(igroup,levels=c('LLMIC','UMIC','HIC'))~vax) + 
#   theme_bw(base_size = 13) +
#   theme(axis.text.x = element_text(angle = 45,  hjust=1,vjust=1),
#         legend.position = 'top') + labs(colour='',x='Effectiveness of remote teaching',y='Density')


ggplot(subset(allallresults,keeprow==T)) + 
  geom_histogram(aes(x=Remote_teaching_effectiveness,y=stat(count / sum(count)),fill=strategy,group=strategy),position='fill',bins = 10) +
  facet_grid(factor(igroup,levels=c('LLMIC','UMIC','HIC'))~vax) + 
  theme_bw(base_size = 13) +
  scale_x_continuous(expand=c(0,0)) +
  scale_y_continuous(expand=c(0,0)) +
  scale_fill_viridis(discrete=T, name="",option='inferno',direction=-1) +
  theme(axis.text.x = element_text(angle = 45,  hjust=1,vjust=1),
        legend.position = 'top') + labs(fill='',x='Effectiveness of remote teaching',y='Proportion')

```


```{r importtoresponse,fig.cap='The relationship between strategy choice and the duration between import time and response time.',echo=F,warning=F,message=F,fig.height=5,fig.width=6}


# ggplot(subset(allallresults,keeprow==T)) + 
#   geom_vline(aes(xintercept=0),colour='grey',linewidth=1.2) +
#   geom_density(aes(x=Response_time-Importation_time,colour=strategy,group=strategy),position='identity',alpha=.5,linewidth=1.25) +
#   facet_grid(factor(igroup,levels=c('LLMIC','UMIC','HIC'))~vax) + 
#   theme_bw(base_size = 13) +
#   theme(axis.text.x = element_text(angle = 45,  hjust=1,vjust=1),
#         legend.position = 'top') + labs(colour='',x='Response time minus importation time',y='Density')

keptresults[,qtime:=rank(Response_time-Importation_time)/.N,by=.(igroup,vax)]
keptresults[,qtime0:=qtime[which.min(abs(Response_time-Importation_time))],by=.(igroup,vax)]

ggplot(keptresults) + 
  geom_histogram(aes(x=qtime,y=stat(count / sum(count)),fill=strategy,group=strategy),position='fill',bins = 10) +
  geom_vline(aes(xintercept=qtime0),colour='grey',linewidth=1.2) +
  facet_grid(factor(igroup,levels=c('LLMIC','UMIC','HIC'))~vax) + 
  theme_bw(base_size = 13) +
  scale_x_continuous(expand=c(0,0)) +
  scale_y_continuous(expand=c(0,0)) +
  scale_fill_viridis(discrete=T, name="",option='inferno',direction=-1) +
  theme(axis.text.x = element_text(angle = 45,  hjust=1,vjust=1),
        legend.position = 'top') + labs(fill='',x='Response time minus importation time (quantile)',y='Proportion')

```


\newpage


## Value of information

The value of information associated with a number of parameters for all costs considered is shown in Figure \@ref(fig:voi). The costs are listed down the y axis. Parameters and parameter groups are along the x axis. Colours indicate the extent to which uncertainty in the input(s) are driving uncertainty in the outcome, with lighter colours representing greater impact.

The first four items on the x axis are the four independent variables: size of the agriculture sector, size of the food and accommodation services sector, fraction of tourism coming from abroad, and internet coverage. While the two parameters driving tourism are impactful on GDP loss, particularly for strategies light on economic closures, they have little impact on total costs. (This relationship is also driven by the distribution of the food and accommodation sector contribution to GVA: the mutual information appears a more balanced metric (Figure \@ref(fig:mi)).) Meanwhile, internet coverage has modest impacts, particularly on education loss and for strategies that employ school closures.

The EVPPI for tourism is high, particularly for lower-income countries because tourism can make up a large part of GDP, and particularly for strategies light on economic closure because then the only sector suffering a shortfall is the Food and accommodation services sector.

The next two items on the x axis are parameter groups. First, both sectors. Second, both tourism parameters. The grouping of parameters shows their combined impact on outcomes, which can be greater than the sum of their individual impacts.

The next columns do not correspond to the "independent variables" of interest but might be expected to influence outcomes: fraction of population who are school age, fraction of population who are in the oldest age group, population size, rate of testing, GDP, $R_0$ and maximum hospital capacity. $R_0$ in particular drives a lot of uncertainty in costs, primarily through YLLs. 

The final four items on the x axis are groups of variables: both age groups; two social-distancing parameters; hospital capacity, the fraction of the population aged 65 and over, and R$_0$; and testing parameters, response time, and R$_0$. 

Some distributions in Figure \@ref(fig:prealpha) are bimodal. For example, GDP loss under the Economic Closures strategy have peaks in density close to zero and also far from zero, with a low-density region in between. Here, in some samples (low GDP loss), the epidemic was not severe enough to warrant closures. This could be because R$_0$ was low, because hospital capacity was high, or both. Similarly, under the Elimination strategy, there is an area of high density at higher costs where the strategy does not work: due to R$_0$ being high, and/or the capacity to test being low, case numbers are not brought low enough and severe economic closures persist throughout, leading to high GDP loss.

These relationships are identified in the value-of-information analyses: the last two columns show value of information for R$_0$, fraction of population aged 65 and over and hospital capacity combined, and R$_0$, testing parameters and social-distancing parameters combined. These variables together explain much of the variance in GDP loss for the Economic Closures and Elimination strategies, respectively.


```{r voi100,fig.cap='\\footnotesize Value of information for 100-day vaccine value.',echo=F,warning=F,message=F,fig.height=10}

param_cutoff <- c('Remote quantile','Time to death')

voiall <- readRDS('code/results/voidiff_0_100.Rds')
rownames(voiall) <- gsub('Deaths:','dYLLs:',rownames(voiall))
rownames(voiall) <- gsub('School:','Education:',rownames(voiall))
rownames(voiall) <- gsub('Cost:','Value:',rownames(voiall))

fullnames <- rownames(voiall)
splitnames <- do.call(rbind,sapply(fullnames,strsplit,': '))
strats <- do.call(rbind,sapply(splitnames[,2],strsplit,', '))

nscen <- nrow(voiall)
nparam <- ncol(voiall)
voibrks <- c(-1,10,30,50,70,101)
discxs <- matrix(cut(as.numeric(voiall),breaks=voibrks,labels=1:(length(voibrks)-1)),
                 nrow=nscen,ncol=nparam)
xvals <- 1:nparam
shiftx <- which(colnames(voiall)%in%param_cutoff)
for(i in 1:length(shiftx)) xvals[xvals>xvals[shiftx[i]]] <- xvals[xvals>xvals[shiftx[i]]] + .1
yvals <- 1:nscen
boundary <- 3
yvals[yvals>boundary] <- yvals[yvals>boundary] + .1*(ceiling(yvals[yvals>boundary]/boundary)-1)
df <- data.frame(x=rep(xvals,each=nscen),y=rep(yvals,nparam),xs=c(discxs[nscen:1,]))

options(repr.plot.width = 1, repr.plot.height = 0.75)
voilbs <- c('<10','10-30','30-50','50-70','70-100')
ggplot(df, aes(x, y, fill = factor(xs,levels=1:(length(voibrks)-1),labels=voilbs))) +
  geom_tile() +
  scale_fill_manual(values = colorRampPalette(c("midnightblue","royalblue","lightskyblue","white"))(length(voibrks)-1)) +   
  theme_bw(base_size=12) +                                   # Minimal theme
  labs(title = "") +
  scale_x_continuous(name='',breaks=xvals,labels=colnames(voiall),expand=c(0,0))+
  theme(axis.text.x.bottom = element_text(angle = 90,  hjust=1,vjust=0.5)) +
  theme(
    plot.title = element_text(hjust = 1),        
    legend.position="right", legend.spacing.x = unit(0.15, 'cm'),legend.box.spacing = unit(0.0, 'cm')) +               
  guides(fill = guide_legend(#nrow = 1,
    title.theme = element_text(size=10),title.vjust = .8,title.hjust = 1,#title.position = "left",      
    #label.position="bottom", 
    label.hjust = 0, #label.vjust = 0.3, 
    #label.theme = element_text(size=8,angle = 45),
    title = 'EVPPI, % ',override.aes=list(colour='black')))  +
  scale_y_continuous(name='',breaks=rev(yvals),labels=strats,expand=c(0,0),
                     sec.axis=sec_axis(trans='identity',breaks=seq(2,12,by=3.1),labels=rev(unique(splitnames[,1])))) +
  coord_flip()
```

```{r voi,fig.cap='\\footnotesize Value of information for BAU, Origin country.',echo=F,warning=F,message=F,fig.height=10}

voiall <- readRDS('code/results/voi_365_0.Rds')
rownames(voiall) <- gsub('Deaths:','dYLLs:',rownames(voiall))
rownames(voiall) <- gsub('School:','Education:',rownames(voiall))

fullnames <- rownames(voiall)
splitnames <- do.call(rbind,sapply(fullnames,strsplit,': '))
strats <- do.call(rbind,sapply(splitnames[,2],strsplit,', '))

nscen <- nrow(voiall)
nparam <- ncol(voiall)
voibrks <- c(-1,10,30,50,70,101)
discxs <- matrix(cut(as.numeric(voiall),breaks=voibrks,labels=1:(length(voibrks)-1)),
                 nrow=nscen,ncol=nparam)
# xvals <- 1:nparam
# shiftx <- which(colnames(voiall)==param_cutoff)
# xvals[xvals>shiftx] <- xvals[xvals>shiftx] + .1
yvals <- 1:nscen
boundary <- 24
yvals[yvals>boundary] <- yvals[yvals>boundary] + .1*(ceiling(yvals[yvals>boundary]/boundary)-1)
df <- data.frame(x=rep(xvals,each=nscen),y=rep(yvals,nparam),xs=c(discxs[nscen:1,]))

options(repr.plot.width = 1, repr.plot.height = 0.75)
voilbs <- c('<10','10-30','30-50','50-70','70-100')
ggplot(df, aes(x, y, fill = factor(xs,levels=1:(length(voibrks)-1),labels=voilbs))) +
  geom_tile() +
  scale_fill_manual(values = colorRampPalette(c("midnightblue","royalblue","lightskyblue","white"))(length(voibrks)-1)) +   
  theme_bw(base_size=12) +                                   # Minimal theme
  labs(title = "") +
  scale_x_continuous(name='',breaks=xvals,labels=colnames(voiall),expand=c(0,0))+
  theme(axis.text.x.bottom = element_text(angle = 90,  hjust=1,vjust=0.5)) +
  theme(
    plot.title = element_text(hjust = 1),        
    legend.position="right", legend.spacing.x = unit(0.15, 'cm'),legend.box.spacing = unit(0.0, 'cm')) +               
  guides(fill = guide_legend(#nrow = 1,
    title.theme = element_text(size=10),title.vjust = .8,title.hjust = 1,#title.position = "left",      
    #label.position="bottom", 
    label.hjust = 0, #label.vjust = 0.3, 
    #label.theme = element_text(size=8,angle = 45),
    title = 'EVPPI, % ',override.aes=list(colour='black')))  +
  scale_y_continuous(name='',breaks=rev(yvals)[seq(2,48,by=3)],labels=strats[seq(2,48,by=3),2],expand=c(0,0),
                     sec.axis=sec_axis(trans='identity',breaks=seq(6.5,48,by=12),labels=rev(unique(splitnames[,1])))) +
  coord_flip()
```


```{r dvoiBAU,fig.cap='Decision VOI for BAU. Which parameters would enable the decision maker to choose a strategy that minimises expected losses for BAU vaccination?',eval=T,echo=F,warning=F,message=F,fig.height=12,include=F,eval=F}
voiall <- c()
for(i in c(365,100)){
  for(j in 0:1){
    voitab <- readRDS(paste0('code/results/decisionvoi',i,'_',j,'.Rds'))*100
    newtab <- voitab[grepl('Cost',rownames(voitab)),]
    rownames(newtab) <- gsub('Cost',paste0(i,' days, ',c('no BPSV','BPSV')[j+1]),rownames(newtab))
    voiall <- rbind(voiall,newtab)
  }
}
# voiall <- readRDS('code/results/decisionvoi365_0.Rds')*100

fullnames <- rownames(voiall)
splitnames <- do.call(rbind,sapply(fullnames,strsplit,': '))

nscen <- nrow(voiall)
nparam <- ncol(voiall)
dvoibrks <- c(-1,seq(0,ceiling(max(voiall)),by=1))
discxs <- matrix(cut(as.numeric(voiall),breaks=dvoibrks,labels=1:(length(dvoibrks)-1),include.lowest = T),
                 nrow=nscen,ncol=nparam)
dyvals <- 1:nscen
dyvals[dyvals>3] <- dyvals[dyvals>3] + .1*(ceiling(dyvals[dyvals>3]/3)-1)
df <- data.frame(x=rep(xvals,each=nscen),y=rep(dyvals,nparam),xs=c(discxs[nscen:1,]))
ilevels <- do.call(rbind,sapply(rownames(voiall),strsplit,': '))
options(repr.plot.width = 1, repr.plot.height = 0.75)
milbs <- dvoibrks[-1]
ggplot(df, aes(x, y, fill = factor(xs,levels=1:(length(dvoibrks)-1),labels=milbs))) +
  geom_tile() +
  scale_fill_manual(values = colorRampPalette(c("midnightblue","royalblue","lightskyblue","white"))(length(dvoibrks)-1)) +   
  theme_bw(base_size=12) +                                   # Minimal theme
  labs(title = "") +
  scale_x_continuous(name='',breaks=xvals,labels=colnames(voiall),expand=c(0,0))+
  theme(axis.text.x.bottom = element_text(angle = 90,  hjust=1,vjust=0.5),
        axis.text.x.top = element_text(angle = 15,  hjust=0,vjust=0)) +
  theme(
    plot.title = element_text(hjust = 1),        
    legend.position="right", legend.spacing.x = unit(0.15, 'cm'),legend.box.spacing = unit(0.0, 'cm')) +               
  guides(fill = guide_legend(#nrow = 1,
    title.theme = element_text(size=10),title.vjust = .8,title.hjust = 1,#title.position = "left",      
    #label.position="bottom", 
    label.hjust = 0, #label.vjust = 0.3, 
    #label.theme = element_text(size=8,angle = 45),
    title = 'EVPPI, % of GDP',override.aes=list(colour='black'))) +
  scale_y_continuous(name='',breaks=dyvals,labels=rev(ilevels[,2]),expand=c(0,0),
                     sec.axis=sec_axis(trans='identity',breaks=dyvals[seq(2,nscen,by=3)],labels=rev(unique(splitnames[,1])))) +
  coord_flip()
```

```{r dvoi100,fig.cap='Decision VOI for 100 days. Which parameters would enable the decision maker to choose a strategy that minimises expected losses for 100-day vaccination?',eval=T,echo=F,warning=F,message=F,fig.height=12,include=F,eval=F}

voiall <- readRDS('code/results/decisionvoi100_0.Rds')*100
rownames(voiall) <- gsub('Deaths:','dYLLs:',rownames(voiall))
rownames(voiall) <- gsub('School:','Education:',rownames(voiall))

nscen <- nrow(voiall)
nparam <- ncol(voiall)
dvoibrks <- c(-1,seq(0,ceiling(max(voiall)),by=1))
discxs <- matrix(cut(as.numeric(voiall),breaks=dvoibrks,labels=1:(length(dvoibrks)-1),include.lowest = T),
                 nrow=nscen,ncol=nparam)
dyvals <- 1:nscen
dyvals[dyvals>3] <- dyvals[dyvals>3] + .1*(ceiling(dyvals[dyvals>3]/3)-1)
df <- data.frame(x=rep(xvals,each=nscen),y=rep(dyvals,nparam),xs=c(discxs[nscen:1,]))
ilevels <- do.call(rbind,sapply(rownames(voiall),strsplit,': '))
options(repr.plot.width = 1, repr.plot.height = 0.75)
milbs <- dvoibrks[-1]
ggplot(df, aes(x, y, fill = factor(xs,levels=1:(length(dvoibrks)-1),labels=milbs))) +
  geom_tile() +
  scale_fill_manual(values = colorRampPalette(c("midnightblue","royalblue","lightskyblue","white"))(length(dvoibrks)-1)) +   
  theme_bw(base_size=12) +                                   # Minimal theme
  labs(title = "") +
  scale_x_continuous(name='',breaks=xvals,labels=colnames(voiall),expand=c(0,0))+
  theme(axis.text.x.bottom = element_text(angle = 90,  hjust=1,vjust=0.5)) +
  theme(
    plot.title = element_text(hjust = 1),        
    legend.position="right", legend.spacing.x = unit(0.15, 'cm'),legend.box.spacing = unit(0.0, 'cm')) +               
  guides(fill = guide_legend(#nrow = 1,
    title.theme = element_text(size=10),title.vjust = .8,title.hjust = 1,#title.position = "left",      
    #label.position="bottom", 
    label.hjust = 0, #label.vjust = 0.3, 
    #label.theme = element_text(size=8,angle = 45),
    title = 'EVPPI, % of GDP',override.aes=list(colour='black'))) +
  scale_y_continuous(name='',breaks=dyvals,labels=rev(ilevels[,2]),expand=c(0,0),
                     sec.axis=sec_axis(trans='identity',breaks=dyvals[seq(2,nscen,by=3)],labels=rev(unique(splitnames[,1])))) +
  coord_flip()
```


```{r mi,fig.cap='Mutual information (MI) for BAU.',eval=T,echo=F,warning=F,message=F,fig.height=12,eval=F}

voiall <- readRDS('code/results/mi.Rds')
rownames(voiall) <- gsub('Deaths:','dYLLs:',rownames(voiall))
rownames(voiall) <- gsub('School:','Education:',rownames(voiall))

nscen <- nrow(voiall)
nparam <- ncol(voiall)
mibrks <- c(-1,10,30,50,70,100)/100
discxs <- matrix(cut(as.numeric(voiall),breaks=mibrks,labels=1:(length(mibrks)-1)),
                 nrow=nscen,ncol=nparam)
df <- data.frame(x=rep(xvals,each=nscen),y=rep(yvals,nparam),xs=c(discxs[nscen:1,]))

options(repr.plot.width = 1, repr.plot.height = 0.75)
milbs <- c('<.1','.1-.3','.3-.5','.5-.7','.7-1')
ggplot(df, aes(x, y, fill = factor(xs,levels=1:(length(mibrks)-1),labels=milbs))) +
  geom_tile() +
  scale_fill_manual(values = colorRampPalette(c("midnightblue","royalblue","lightskyblue","white"))(length(mibrks)-1)) +   
  theme_bw(base_size=12) +                                   # Minimal theme
  labs(title = "") +
  scale_x_continuous(name='',breaks=xvals,labels=colnames(voiall),expand=c(0,0))+
  theme(axis.text.x.bottom = element_text(angle = 90,  hjust=1,vjust=0.5)) +
  theme(
    plot.title = element_text(hjust = 1),        
    legend.position="right", legend.spacing.x = unit(0.15, 'cm'),legend.box.spacing = unit(0.0, 'cm')) +               
  guides(fill = guide_legend(#nrow = 1,
    title.theme = element_text(size=10),title.vjust = .8,title.hjust = 1,#title.position = "left",      
    #label.position="bottom", 
    label.hjust = 0, #label.vjust = 0.3, 
    #label.theme = element_text(size=8,angle = 45),
    title = 'MI, nats',override.aes=list(colour='black'))) +
  scale_y_continuous(name='',breaks=rev(yvals)[seq(2,48*2,by=3*2)],labels=strats[seq(2,48*2,by=3*2),2],expand=c(0,0),
                     sec.axis=sec_axis(trans='identity',breaks=seq(6.5+6,48*2,by=12*2),labels=rev(unique(splitnames[,1])))) +
  coord_flip()
```


\newpage

To understand the relationship between a parameter and an outcome, e.g. whether the relationship is linear and increasing or decreasing, whether it is nonlinear, whether it is driven by extreme values, they must be plotted against each other. Likewise, a relationship between a parameter pair and an outcome can be plotted, e.g. Figure \@ref(fig:tourismgdp): for middle-income countries in a pre-Alpha SARS-CoV-2 pandemic with the "No Closures" strategy, GDP loss is greatest when both the food and accommodation services GVA as fraction of GDP and international tourism as a fraction of tourism are high.


```{r interneted,fig.cap='Relationship between R$_0$ and total costs for Origin UMICs with the "School Closures" strategy.',echo=F,warning=F,message=F}

ggplot(subset(allallresults,igroup=='UMIC'&strategy=='School Closures'&BPSV=='No'&vaccination_level==365),aes(x=R0,y=Cost)) +
  geom_point(colour='navyblue') +
  theme_bw(base_size=15) + geom_smooth(formula=y~ns(x,df=3),method='glm',colour='hotpink',se = F,size=2) +
  labs(x=bquote(R[0]),y='Total socio-economic cost, % of GDP')



```

```{r tourismsecgdp,fig.cap='Relationship between the "tourism sector" size and GDP loss for Origin LLMICs with the "No Closures" strategy.',echo=F,warning=F,message=F}
ggplot(subset(allallresults,igroup=='LLMIC'&strategy=='No Closures'&BPSV=='No'&vaccination_level==365),
       aes(y=GDP_loss,x=rank(Food_sector*100))) +
  geom_point(colour='navyblue') +
  theme_bw(base_size=15) +
  theme_bw(base_size=15) + geom_smooth(formula=y~ns(x,df=3),method='glm',colour='hotpink',se = F,size=2) +
  labs(x='Food and accommodation services GVA as % of GDP',y='GDP loss, %')

# with(subset(allallresults,igroup=='LLMIC'&strategy=='No Closures'&BPSV=='No'&vaccination_level==365),plot(Food_sector,rank(Food_sector)))

```

```{r tourismgdp,fig.cap='Relationship between tourism parameters and GDP loss for LLMICs with the "No Closures" strategy.',echo=F,warning=F,message=F}

ggplot(subset(allallresults,igroup=='LLMIC'&strategy=='No Closures'&BPSV=='No'&vaccination_level==365)) +
  geom_point(aes(y=International_tourism*100,x=Food_sector*100,colour=GDP_loss)) +
  theme_bw(base_size=15) +
  labs(x='Food and accommodation services GVA as % of GDP',y='Percent of tourism that is international',colour='GDP loss, %')
```



\newpage


# Conclusions

Using simulation modelling, we have projected distributions of epidemic losses -- of life, GDP, and education -- for seven pathogenic profiles, four stylised mitigation strategies, and three levels of country income. We assessed what the impact is of four economic variables in our model: fraction of GDP from the agriculture sector, fraction of GDP from the food and accommodation services sector, fraction of tourism that comes from abroad, and internet coverage. 

We found that the tourism-related variables impacted GDP loss for the No Closure strategy, which is because GDP losses will be suffered only in this sector when there is no mandated closure. This means the GDP loss will depend on the extent to which the economy is depending on this sector. We found that Education losses depend to some extent on internet coverage, because our model assumes that internet access can be used to mitigate losses by enabling remote learning. We found little effect of the size of the agricultural sector.

In parallel, we present a selection of other model parameters, including those related to demography (e.g. the fraction of the population who are of school age), to the economy (e.g. GDP), to the health system (e.g. hospital capacity), to the pandemic response (e.g. the rate of testing), and to the pathogen (e.g. the basic reproductive number, R$_0$). We found that these variables -- in combinations up to four -- account for much of the variability in outcomes. 

## The modelling framework

Ours is a mechanistic simulation model. The model encodes complex relationships between demographic, epidemic and economic variables. With simulation, it allows us to explore outcomes as consequences of inputs using information- and decision-theoretic methods. Modelling allows *in silico* experimentation, which is crucial for questions pertaining to rare events with small and confounded datasets, as cross-sectional country data are. The model allows us to ask questions about cause and effect that cannot be asked in reality and rarely can be inferred from observational data.

The challenge we face with modelling, then, is to be confident that our model mimics reality, or at least captures the elements with which we are concerned.

## The economic model

We have used a simple economic model that allows us to estimate GDP loss in a year assuming that sector closures follow mandates. The mandates we use are schematic and representative of GVA profiles seen in different countries in 2020.

The economic model is static, and does not take into account any dynamics such as feedback, changes to demand, supply and supply chains, changes in international trade, or any macroeconomic factors. As such, to model longer-term economic impacts (apart from the impact of lost education) is beyond the scope of this model.

For example, Figure \@ref(fig:gdpdata2) shows the relationship between GDP loss in the first year (2020) and GDP loss in the second year (2021) following the outbreak of COVID-19. There is heterogeneity in losses in the first year, but also in whether or not the economy recovers in the second year, and to what extent. The recovery is arguably a more important phenomenon to capture than initial losses, and it is not something that can be captured by our economic model. However, a model of recovery / future losses would include initial loss as an input, which our model could provide.

```{r gdpdata2,fig.cap='GDP loss and recovery. On the x axis is the GDP of 2020 relative to its 2019 projected value (IMF). On the y axis is 2021 GDP relative to its 2019 projected value relative to the same value for 2020 (ratio of ratios). x values below 100 represent a loss in the year 2020. y values above 0 represent recovery (i.e. growth exceeded what was expected in 2019); y values equal to zero represent a fixed level of loss; y values less than zero represent increasing loss.',echo=F,warning=F,message=F}


gdpdata2 <- read.csv('data/twoyearhits.csv')
gdpdata2 <- left_join(gdpdata2,incomelevels,by='Country.Code')
ggplot(subset(gdpdata2,!is.na(IncomeGroup)&IncomeGroup!='')) + 
  geom_vline(aes(xintercept=100),col='grey') + 
  geom_hline(aes(yintercept=0),col='grey') + 
  geom_point(aes(x=X2020*100,y=relhit*100-100),colour='navyblue',fill='grey') +
  facet_wrap(~IncomeGroup) +
  theme_bw(base_size = 15) +
  geom_smooth(aes(x=X2020*100,y=relhit*100-100),formula=y~x,method='glm',se=F) + 
  labs(x='2020 GDP, % of projected value',y='2021 recovery, %')
# ggplot(subset(gdpdata2,!is.na(IncomeGroup)&IncomeGroup!='')) + 
#   geom_histogram(aes(x=X2021),colour='navyblue',fill='grey') +
#   facet_wrap(~IncomeGroup) +
#   theme_bw(base_size = 15)
# setDT(gdpdata2)[is.na(X2021)==F,quantile(X2021,c(0.1,0.5,0.9)),by=IncomeGroup]
# summary(glm(X2021~X2020 + IncomeGroup + offset(X2020),data=gdpdata2))
# with(gdpdata2,plot(X2020,X2021))
```



\newpage




# References

<div id="refs"></div>

\newpage


